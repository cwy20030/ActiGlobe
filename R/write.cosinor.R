#  File ActiGlobe/R/write.cosinor.R
#
#  Copyright (C) 2025  C. William Yao, PhD
#
#
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU Affero General Public License as
#  published by the Free Software Foundation, either version 3 of the
#  License, or any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU Affero General Public License for more details.
#
#  You should have received a copy of the GNU Affero General Public License
#  along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
#
#
#' @title Generate Report for Daily Cosinor and Generate Summary Plot
#'
#' @description
#' A multi-wrapper function which generate data trend using
#' \code{\link[ggplot2]{geom_smooth}} and model plot using
#' \code{\link{CosinorM}} or \code{\link{CosinorM.KDE}}. All daily results
#' could be found in the exported report. A summary file in .csv format is
#' also generated to update the original `Bdf` with cosinor model coefficients
#' for each day.
#'
#' @import gridExtra ggplot2 grDevices utils stats
#'
#' @param Dir The directory where the recordings to be exported <e.g.
#' "C:/Users/___YOUR USERNAME___/UPSTREAM FOLDER/.../FOLDER NAME/">
#' @param ID The subject's ID which would be used to create a folder.
#' @param DailyAct A data.frame list generated by `Act2Daily()`
#' @param Bdf A \code{\link{BriefSum}} object. Note, if jet lag occurred during
#' the recording, please, update the metadata using \code{\link{TAdjust}}
#' before passing to this function.
#' @param VAct Optional character. Name of the activity column in each
#' data.frame object (`df`) in `DailyAct`. If NULL,
#'   defaults to the second column of `df`.
#' @param VTm Optional character. Name of the activity column in each
#' data.frame object (`df`) in `DailyAct`. If NULL,
#'   defaults to the first column of `df`.
#' @param method Character string specifying estimation method
#' \itemize{
#'   \item "OLS": Ordinary least square cosinor model via
#'   \code{\link{CosinorM}}. (default)
#'   \item "FGLS": Feasible generalized least squares cosinor model via
#'   \code{\link{CosinorM}}.
#'   \item "KDE": Gaussian kernel density estimate (KDE) on circular time
#'   (hours of day) via \code{\link{CosinorM.KDE}}.
#' }
#' @param tau Numeric scalar or vector for the assumed circadian period,
#' passed to \code{\link{CosinorM}}. Default is 24 for single-phase; multiple
#' phases can be supplied via [c()].
#' @param ph Optional logical scaler; if only a single period is assigned to
#' tau, TRUE will force the function to append the post-hoc circadian estimates
#' instead of the model estimates. (default: FALSE)
#' @param overwrite Logical; if TRUE, existing files with the same name will be
#' overwritten. Default = FALSE.
#'
#' @returns Creates a multi-page `.pdf` visual document and a text-based `.csv`
#' summary.
#' \itemize{
#' \item PDF  A multi-page PDF written to `pdfDir` (one file per `ID`). Each
#' page corresponds to a recording day and contains two panels: the top panel
#' shows the raw activity (points) and a smoothed trend; the bottom panel shows
#'  the model fit for the same day
#' \item `Summary.csv` An updated `Bdf` documentation with one row per
#' recording day. Model-based circadian parameters are appened at the end of
#' the file for each day.
#' }
#'
#' @seealso
#' \code{\link{Act2Daily}} \code{\link{CosinorM}} \code{\link{CosinorM.KDE}}
#'
#' @examples
#' \dontrun{
#'
#' # Import data
#' data (FlyEast)
#'
#'
#' # Create quick summary of the recording with adjustment for daylight saving.
#' BdfList <-
#'     BriefSum (
#'         df = FlyEast,
#'         SR = 1 / 60,
#'         Start = "2017-10-24 13:45:00"
#'     )
#'
#'
#' # Let's extract the quick summary of the recording
#' Bdf <- BdfList$Bdf
#' df <- BdfList$df
#'
#' ### Note that since the original data was affected by travel-induced time
#' ### shift, the recordings would not be properly segmented from 2017-11-02.
#'
#' ## To avoid time shift due to travelling, we will keep only the first 8 days.
#' Bdf <- Bdf [1:8, ]
#'
#'
#' ## Segment Data by Day
#' dfList <-
#'     Act2Daily (
#'         df = df,
#'         Bdf = Bdf,
#'         VAct = "Activity",
#'         VTm = "Time",
#'         Incomplete = TRUE,
#'         Travel = TRUE
#'     )
#'
#'
#' ## Generate graphic summary of daily recordings in pdf with an addition
#' ## `Summary` file just like write.act
#' write.cosinor (
#'     Dir = getwd (), ## Export to the current working directory
#'     ID = "JD",
#'     DailyAct = dfList$Daily_df,
#'     Bdf = Bdf,
#'     VAct = "Activity",
#'     VTm = "Time"
#' )
#'
#' ## To see what was exported copy the path generated by the code below and
#' ## paste it as an url in a web browser or the file explorer.
#' getwd ()
#' }
#'
#' @keywords write export actigraphy cosinor trend
#' @export


write.cosinor <- function (Dir, ID, DailyAct, Bdf, VAct = NULL, VTm = NULL,
                           method = "OLS", tau = 24, ph = FALSE,
                           overwrite = FALSE) {
    ## Get Essential Info -----------------
    nT <- length (tau)
    D <- names (DailyAct)
    U <- Bdf$UTC

    ### Set default variable names for activity and time columns
    if (is.null (VAct) || is.null (VTm)) {
        first_df <- DailyAct [[1]]
        if (is.null (first_df) || length (DailyAct) == 0) {
            stop ("DailyAct must contain at least one data frame")
        }
        if (is.null (VAct)) VAct <- names (first_df) [[2]]
        if (is.null (VTm)) VTm <- names (first_df) [[1]]
    }

    ## Initialize all cosinor results -----------------------
    cosinor_setup <- setup_cosinor_columns (tau, ph)
    nVNames <- cosinor_setup$nVNames
    KeyTerm <- cosinor_setup$KeyTerm
    Bdf [nVNames] <- NA

    ## Setup output directories and files ----------------
    file_paths <- setup_output_paths (Dir, ID, overwrite)
    fDir <- file_paths$fDir
    pdfDir <- file_paths$pdfDir

    grDevices::pdf (pdfDir, onefile = TRUE, paper = "a4r")


    ### Plot ----------------
    for (d in D) {
        # print (d) ## For fail-check function purposes
        df <- DailyAct [[d]]

        if (!is.null (df)) {
            Act <- ValInput (x = df [[VAct]], type = "Act")
            Tm <- ValInput (x = df [[VTm]], type = "Tm")

            df [[VAct]] <- Act
            df [[VTm]] <- Tm

            #### Get the time zone for the current ID and date
            TZ <- U [D == d]

            #### Just in acse, provide a zero imputation for NA.
            Act [is.na (Act)] <- 0

            if (!all (Act == 0)) {
                ### Create activity trend for the top panel ---------------
                top.plot <-
                    ggplot2::ggplot (df, aes (x = Tm, y = Act)) +
                    geom_point (aes (color = "Original Measure")) +
                    geom_smooth (aes (color = "Smoothed Trend")) +
                    labs (
                        title = d,
                        subtitle = TZ,
                        x = "Hour",
                        y = "Activity"
                    ) +
                    theme (plot.title = element_text (hjust = 0.5)) +
                    scale_color_manual (
                        values = c (
                            "Original Measure" = "black",
                            "Smoothed Trend" = "blue"
                        ),
                        name = "Legend Title"
                    ) +
                    theme_bw ()


                ### Fit cosinor models with 24Hr period  ----------------------
                if (method == "KDE") {
                    m1 <- CosinorM.KDE (time = Tm, activity = Act)
                } else {
                    m1 <- CosinorM (time = Tm, activity = Act, tau = tau,
                                    method = method)
                }

                if (all (nT == 1, isFALSE (ph))) {
                    Cftemp <- m1$coef.cosinor

                    # MESOR, Amplitude, Acrophase in radians
                    Coef <- Cftemp [grepl (KeyTerm, names (Cftemp))]

                    # Extract the name of Acrophase to compute the time
                    VAcro <- names (Coef) [grepl ("Acro", names (Coef))]

                    Coef [[4]] <- Rad2Hr (Coef [VAcro], tau = tau)
                    names (Coef) [[4]] <- paste0 (VAcro, ".time")
                } else {
                    Cftemp <- m1$post.hoc
                    Cftemp <- Cftemp [match (nVNames, names (Cftemp))]
                    Coef <- Cftemp [grepl (KeyTerm, names (Cftemp))]
                    # MESOR, Bathyphase.time, Trough.ph,
                    # Acrophase.time, Peak, Amplitude
                }

                ### Update the report with cosinor model coefficients
                Bdf [Bdf$Date == d, nVNames] <- Coef

                #### Create the bottom plot for cosinor models -----------
                bottom.plot <- ggCosinorM (m1, title_extra = d)
            } else { ### If no activity recorded

                ### Create activity trend for the top panel ---------------
                top.plot <- ggplot (df, aes (x = Tm, y = Act)) +
                    geom_point (color = "red") +
                    labs (
                        title = d,
                        subtitle = " No activity recorded",
                        x = "Hour",
                        y = "Activity"
                    ) +
                    theme_bw ()


                ### No update the report with cosinor model coefficients

                #### Create the bottom plot for cosinor models -----------
                bottom.plot <- ggplot () +
                    labs (
                        title = d,
                        subtitle = " No activity recorded",
                        x = "Hour",
                        y = "Activity"
                    ) +
                    theme_minimal () +
                    theme (
                        plot.title       = element_text (hjust = 0.5),
                        # keep legend space but show nothing
                        legend.position  = "right"
                    ) +
                    # add empty scales so legend space is reserved
                    scale_colour_manual (
                        name = "",
                        values = c ("dummy" = NA),
                        breaks = NULL
                    ) +
                    scale_fill_manual (
                        name = "",
                        values = c ("dummy" = NA),
                        breaks = NULL
                    )

                # Arrange the top and bottom plots in a grid
                grid.arrange (top.plot, bottom.plot)
            }
        }
    }

    ## Close the PDF file -------------
    dev.off ()

    ## Write the merged summary report to a CSV file --------------
    message ("Updating the summary file")

    BdfDir <- paste0 (fDir, "/Summary.csv")
    if (isFALSE (overwrite)) {
        if (file.exists (BdfDir)) BdfDir <- paste0 (BdfDir, " ", Sys.time ())
    }
    utils::write.csv (Bdf, BdfDir, row.names = FALSE)
}


## Helper functions for write.cosinor ---------------

#' @title Setup Cosinor Columns
#' @noRd
setup_cosinor_columns <- function (tau, ph) {
    if (all (length (tau) == 1, isFALSE (ph))) {
        nVNames <- c ("MESOR", "Amplitude", "Acrophase", "Acrophase.time")
        KeyTerm <- "MESOR|Amplitude|Acrophase"
    } else {
        nVNames <- c (
            "MESOR", "Bathyphase.time", "Trough.ph", "Acrophase.time",
            "Peak", "Amplitude"
        )
        KeyTerm <-
            "MESOR|Bathyphase.time|Trough.ph|Acrophase.time|Peak|Amplitude"
    }
    list (nVNames = nVNames, KeyTerm = KeyTerm)
}


#' @title Setup Output Paths
#' @noRd
setup_output_paths <- function (Dir, ID, overwrite) {
    fDir <- paste0 (Dir, "/", ID)
    if (!dir.exists (fDir)) dir.create (fDir)

    pdfDir <- paste0 (fDir, "/", ID, ".pdf")
    if (isFALSE (overwrite)) {
        if (file.exists (pdfDir)) pdfDir <- paste0 (pdfDir, " ", Sys.time ())
    }

    list (fDir = fDir, pdfDir = pdfDir)
}
